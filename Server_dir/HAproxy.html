<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Jack_Chim HAproxy 开发笔记_高级_工程师_Blog_Wiki</title>
<meta name="description" content="" />
<meta name="keywords" content="" />
<link rel="stylesheet" type="text/css" href="../css/style.css" media="screen" />
<!-- <link rel="shortcut icon" href="" /> -->
<link rel='stylesheet' id='wp-pagenavi-css'  href='../css/pagenavi-css.css' type='text/css' media='all' />
<script type='text/javascript' src='../js/jquery.js'></script>


<!-- for SyntaxHighlighter core -->
<script type="text/javascript" src="../syntaxhighlighter/scripts/shCore.js"></script>
<link type="text/css" rel="stylesheet" href="../syntaxhighlighter/styles/shCore.css"/>
<!-- for SyntaxHighlighter theme -->
<link type="text/css" rel="stylesheet" href="../syntaxhighlighter/styles/shThemeMidnight.css"/>
<!-- for SyntaxHighlighter syntax -->
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushBash.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushCpp.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushCss.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushJava.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushJScript.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushPhp.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushPython.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushXml.js"></script>
<script type="text/javascript" src="../syntaxhighlighter/scripts/shBrushPlain.js"></script>

<script type="text/javascript" src="../js/jquery.js"></script>

<!-- for SyntaxHighlighter execute -->
<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
<script type="text/javascript">
     SyntaxHighlighter.all()
</script>
<meta name="generator" content="" />
</head>

<body>
<div align="center">
<div id="wrapper">
<!--// header Start-->
<div id="hd">
	<div id="sitemeta">
		<ul>
			<li class="rss"><a href="http://feed.feedsky.com/">Subscribe to articles using RSS Feed</a></li>
  		</ul>
	</div>
	<div id="titlewrapper">
		<div id="blogtitle">
			<h1><a href="../index.html">Jack Chim'Code Notes</a></h1>
		</div>
		<div id="menu">
			<ul>
				<li><div id="blogdescription"> Keep It Simple and Stupid.</div></li>
				<li><a href="../index.html">Home</a></li>
				<li class="page_item page-item-2"><a href="../about.html">About</a></li>
			</ul>
		</div>
	</div>
	<div class="clear">&nbsp;</div>

	<div class="clear">&nbsp;</div>
</div>
<!--// header End-->


<!--// sidebar Start-->
<div id="sidebar" class="yui-b">
<ul class="sidebar">
<li id="search-3" class="widget widget_search"><form method="get" id="searchform" action="">
<input type="text" size="14" value="" name="s" id="s" class="s" />
<input type="submit" id="searchsubmit" value="GO" />
</form>
<BR><BR></li>
<li id="tag_cloud-3" class="widget widget_tag_cloud"><h2 class="widgettitle">Me</h2>
<br>
<div class="tagcloud">

	<span class="icons_github"></span> <a href='https://github.com/ziikii' target="_blank"  >GitHub </a><br>
	<span class="icons_twitter"></span> <a href='https://twitter.com/jack_chim'  target="_blank" >Twitter </a> <br>
	<span class="icons_linkedin"></span> <a href='http://www.linkedin.com/in/jackchim' target="_blank"  >Linkedin </a><br>
	<span class="icons_sinaweibo"></span> <a href='http://weibo.com/u/1893763090' target="_blank" >Sina Weibo</a><br>
	<span class="icons_mail"></span>     <a href='#'  target="_blank" >Mail:ziikii1#qq.com</a><br>

</div>
</li>
<br>
<li id="categories-4" class="widget widget_categories"><h2 class="widgettitle">Categories</h2>
		<ul>
<li class="cat-item cat-item-67"><a href="../Programming_dir/Programming.html" >Programming</a></li>
<li class="cat-item cat-item-6"><a href="../Security_dir/Security.html" >Security</a></li>
<li class="cat-item cat-item-6"><a href="../Database_dir/Database.html" >Database</a></li>
<li class="cat-item cat-item-6"><a href="../Docs_dir/Docs.html" >Docs</a></li>
<li class="cat-item cat-item-6"><a href="../Desktop_dir/Desktop.html" >Desktop</a></li>
<li class="cat-item cat-item-6"><a href="../OS_dir/OS.html" >OS</a></li>
<li class="cat-item cat-item-6"><a href="../Web_dir/Web.html" >Web</a></li>
<li class="cat-item cat-item-6"><a href="../Develop_dir/Develop.html" >Develop/Tools</a></li>
<li class="cat-item cat-item-6"><a href="../Server_dir/Server.html" >Server</a></li>
<li class="cat-item cat-item-6"><a href="../Editor_dir/Editor.html" >Editor</a></li>
<li class="cat-item cat-item-6"><a href="../Design_dir/Design.html" >Design</a></li>
<li class="cat-item cat-item-6"><a href="../English_dir/English.html" >English notes</a></li>

		</ul>
</li>

<li id="archives-4" class="widget widget_archive"><h2 class="widgettitle"><a href="../diary/diary.html" target="_blank">Diary</a></h2>
		<ul>
	<li><a href='../diary/2012.html' title=''>2012 Year</a></li>
	<li><a href='../diary/2011.html' title=''>2011 Year</a></li>
		</ul>
</li>
<li id="linkcat-2" class="widget widget_links"><h2 class="widgettitle">Site & Tools</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://stackoverflow.com/" target="_blank">Stackoverflow </a></li>
<li><a href="http://www.ostools.net/">ostools</a></li>

	</ul>
</li>

</ul>
</div>
<!--// sidebar End-->



<!--// content Start-->
<div id="content">

<h1 ><a  href="">HAproxy</a> Page</h1>


<p>
HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。根据官方数据，其最高极限支持10G的并发。
<strong>专门是一款的用于均衡负载的应用代理。其自身并不能提供http服务</strong>
</p>
<ul>
<li>
<a href="http://haproxy.1wt.eu/">haproxy官网</a> | <a href="http://haproxy.1wt.eu/download/1.4/ ">Download</a> | <a href="http://haproxy.1wt.eu/download/1.5/doc/configuration.txt ">HAProxy 1.5 Configuration Manual</a>

</ul>

<ul>
<li>
<a href="https://github.com/ziikii/haproxy ">haproxy+keepalived 一键安装包</a>

</ul>
<hr />
<h2 id="toc_0.1">Tools</h2>
<ul>
<li>
<a href="http://feurix.org/projects/hatop/ ">HAProxy监控工具 HATop</a>

</ul>

<hr />
<h2 id="toc_0.2">Other Solutions</h2>

<ul>
<li>
<a href="http://trafficserver.apache.org/ ">Traffic Server</a>

</ul>

<hr />
<h2 id="toc_0.3">特性</h2>
<h4 id="toc_0.3.0.1">内容交换 :</h4>
<p>
可以根据请求(request)的任何一部分 来选择一组服务器, 比如请求的 URI , Host头(header) , cookie , 以及其他任何东西. 当然，对那些静态分离的站点来说，对此特性还有更多的需求。 
</p>

<h4 id="toc_0.3.0.2">全透明代理 :</h4>
<p>
可以用 客户端IP地址 或者任何其他地址来连接后端服务器. 这个特性仅在Linux 2.4/2.6内核打了cttproxy 补丁后才可以使用. 这个特性也使得为某特殊服务器处理部分流量同时又不修改服务器的地址成为可能。 
</p>

<h4 id="toc_0.3.0.3">基于树的更快的调度器 :</h4>
<p>
1.2.16以上的版本要求所有的超时都设成同样的值以支持数以万计的全速连接. 这个特性已经移植到1.2.17. 
</p>

<h4 id="toc_0.3.0.4" class="justcenter">内核TCP拼接 :</h4>
<p>
  避免了内核到用户然后用户到内核端的数据拷贝, 提高了吞吐量同时又降低了CPU使用率 . Haproxy 1.3支持Linux L7SW 以满足在商用硬件上数Gbps 的吞吐的需求。 
</p>

<h4 id="toc_0.3.0.5">连接拒绝 :</h4>
<p>
因为维护一个连接的打开的开销是很低的，有时我们很需要限制攻击蠕虫(attack bots)，也就是说限制它们的连接打开从而限制它们的危害。 这个已经为一个陷于小型DDoS攻击的网站开发了而且已经拯救了很多站点。 
</p>

<h4 id="toc_0.3.0.6">细微的头部处理 :</h4>
<p>
使得编写基于header的规则更为简单，同时可以处理URI的某部分。 
</p>

<h4 id="toc_0.3.0.7">快而可靠的头部处理 :</h4>
<p>
使用完全RFC2616 兼容的完整性检查对一般的请求全部进行分析和索引仅仅需要不到2ms 的时间。 
</p>

<h4 id="toc_0.3.0.8">模块化设计 :</h4>
<p>
允许更多人加入进此项目，调试也非常简单. poller已经分离, 已经使得它们的开发简单了很多. HTTP已经从TCP分离出来了，这样增加新的七层特性变得非常简单. 其他子系统也会很快实现模块化 
</p>

<h4 id="toc_0.3.0.9">投机I/O 处理 :</h4>
<p>
在一个套接字就绪前就尝试从它读取数据。poller仅推测哪个可能就绪哪个没有，尝试猜测，并且如果成功，一些开销很大的系统调用就可以省去了。如果失败，就会调用这些系统调用。已知的使用Linux epoll()已经净提升起码10%了。 
</p>

<h4 id="toc_0.3.0.10">ACLs :</h4>
<p>
使用任意规则的任意组合作为某动作的执行条件。 
</p>

<h4 id="toc_0.3.0.11">TCP 协议检查 :</h4>
<p>
结合ACL来对请求的任意部分进行检查，然后再进行转发。这就可以执行协议验证而不是盲目的进行转发。比如说允许SSL但拒绝SSH。 
</p>

<h4 id="toc_0.3.0.12">更多的负载均衡算法 :</h4>
<p>
现在，动态加权轮循(Dynamic Round Robin)，加权源地址哈希(Weighted Source Hash)，加权URL哈希和加权参数哈希(Weighted Parameter Hash)已经实现。其他算法比如Weighted Measured Response Time也很快会实现。
</p>

<hr />
<h2 id="toc_0.4">安装和配置</h2>


<p>
配置文档
haproxy.cfg
</p>

<p>
加载到开机服务启动列表
chkconfig --add haproxy 
</p>

<p>
配置日志：
/etc/syslog.conf 
</p>

<p>
<strong>WEB 均衡负载 &amp; 虚拟主机</strong>
</p>
<pre>
listen  localhost 0.0.0.0:1080                   #运行的端口及主机名
mode    http
option  httpchk GET /index.htm              #用于健康检测的后端页面
server  s1 127.0.0.1:3121 weight 3 check  #后端的主机 IP &amp;权衡
server  s2 127.0.0.1:3122 weight 3 check  #后端的主机 IP &amp;权衡
</pre>


<table>
<tr>
<th>
参数
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
s1
</td>
<td>
是可自己定义的服务器别名
</td>
</tr>
<tr>
<td>
127.0.0.1:3121
</td>
<td>
服务器的IP地址以及端口号
</td>
</tr>
<tr>
<td>
weight 3
</td>
<td>
所能分配到请求的高低权衡，数字越大分配到的请求数就越高
</td>
</tr>
<tr>
<td>
check
</td>
<td>
接受 haproxy 的定时检查，以确定后端服务器的健康情况。
</td>
</tr>
<tr>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
</table>

<hr />
<p>
<strong>相关启动参数介绍</strong>
</p>

<table>
<tr>
<th>
参数
</th>
<th>
说明
</th>
</tr>
<tr>
<td>
-d
</td>
<td>
前台，debug模式
</td>
</tr>
<tr>
<td>
-D
</td>
<td>
daemon模式启动
</td>
</tr>
<tr>
<td>
-q
</td>
<td>
安静模式,不输出信息
</td>
</tr>
<tr>
<td>
-V
</td>
<td>
详细模式
</td>
</tr>
<tr>
<td>
-c
</td>
<td>
对配置文件进行语法检查
</td>
</tr>
<tr>
<td>
-s
</td>
<td>
显示统计数据
</td>
</tr>
<tr>
<td>
-l
</td>
<td>
显示详细统计数据
</td>
</tr>
<tr>
<td>
-dk
</td>
<td>
不使用kqueue
</td>
</tr>
<tr>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
<tr>
<td>
-ds
</td>
<td>
不使用speculative epoll
</td>
</tr>
<tr>
<td>
-de
</td>
<td>
不使用epoll
</td>
</tr>
<tr>
<td>
-dp
</td>
<td>
不使用poll
</td>
</tr>
<tr>
<td>
-db
</td>
<td>
禁用后台模式，程序跑在前台
</td>
</tr>
<tr>
<td>
-sf &lt;pidlist&gt;
</td>
<td>
程序启动后向pidlist里的进程发送FINISH信号，这个参数放在命令行的最后
</td>
</tr>
<tr>
<td>
-st &lt;pidlist&gt;
</td>
<td>
程序启动后向pidlist里的进程发送TERMINATE信号，这个参数放在命令行的最后
</td>
</tr>
<tr>
<td>
&nbsp;
</td>
<td>
&nbsp;
</td>
</tr>
</table>

<hr />

<h2 id="toc_0.5">资源 (resources)</h2>

<ul>
<li>
<a href="http://cn.haproxy.org ">Haproxy 中文</a>

<li>
<a href="http://www.haproxy.org ">Haproxy 英文</a>

<li>
<a href="http://www.oschina.net ">中国开源社区</a>

<li>
<a href="http://ben.timby.com/?page_id=210 ">Load balancing FTP, by Ben Timby</a>

<li>
<a href="http://robert.penz.name/386/howto-setup-a-haproxy-as-fault-tolerant-high-available-load-balancer-for-multiple-caching-web-proxies-on-rhelcentossl/comment-page-1/\#comment-1064 ">Howto setup a haproxy as fault tolerant / high available load balancer for multiple caching web proxies on RHEL/Centos/SL</a>

<li>
<a href="http://www.slideshare.net/ricbartm/load-balancing-at-tuenti ">Load balancing @Tuenti, by Ricardo Bartolomé</a>

<li>
<a href="http://blog.exceliance.fr/2011/09/16/benchmarking_ssl_performance/ ">Benchmarking SSL performance</a>

<li>
<a href="http://alohalb.wordpress.com/2011/06/17/smart_content_switching_for_news_website/ ">Smart Content Switching for News Website</a>

<li>
<a href="http://3-4-5-6.blogspot.com/2011/03/ha-proxy-for-exchange-2010-deployment.html ">HA Proxy for Exchange 2010 Deployment &amp; SMTP Restriction</a>

<li>
<a href="http://flavio.tordini.org/a-more-stable-mysql-with-haproxy/comment-page-1 ">A more stable MySQL with HAProxy</a>

<li>
<a href="http://equima.pfpfree.net/2010/benchmarking-haproxy-ubuntu-vs-freebsd/ ">Benchmarking HAProxy under VMware : Ubuntu vs FreeBSD</a>

<li>
<a href="http://blog.serverfault.com/post/1016491873/ ">Stack Overflow: Better rate limiting for all with HAProxy</a>

<li>
<a href="http://blog.rightscale.com/2010/04/01/benchmarking-load-balancers-in-the-cloud/ ">Benchmarking Load Balancers in the Cloud</a>

<li>
<a href="http://www.alexwilliams.ca/blog/2009/08/10/using-haproxy-for-mysql-failover-and-redundancy/ ">Using HAProxy for MySQL failover and redundancy</a>

<li>
<a href="http://www.howtoforge.com/setting-up-a-high-availability-load-balancer-with-haproxy-keepalived-on-debian-lenny ">Setting up a high availability load blancer with haproxy and keepalived on debian lenny</a>

<li>
<a href="http://blog.loadbalancer.org/configure-haproxy-with-tproxy-kernel-for-full-transparent-proxy/ ">Configure HAProxy with TPROXY kernel for full transparent proxy</a>

<li>
<a href="http://www.lastengine.com/99/installing-haproxy-load-balancing-for-http-and-https/ ">Installing HAProxy load-balancing for HTTP and HTTPS</a>

<li>
<a href="http://agiletesting.blogspot.com/2009/03/haproxy-x-forwarded-for-geoip-keepalive.html ">HAProxy, X-Forwarded-For, GeoIP, KeepAlive</a>

<li>
<a href="http://agiletesting.blogspot.com/2009/02/load-balancing-in-amazon-ec2-with.html ">Load Balancing in Amazon EC2 with HAProxy</a>

<li>
<a href="http://www.joeandmotorboat.com/2009/01/27/couchdb-load-balancing-and-replication-using-haproxy/ ">CouchDB Load Balancing and Replication using HAProxy</a>

<li>
<a href="http://www.igvita.com/2008/12/02/zero-downtime-restarts-with-haproxy/ ">Zero-Downtime restarts with HAProxy</a>

<li>
<a href="http://www.olivepeak.com/blog/posts/read/free-your-port-80-with-haproxy ">Free your port 80 with HAProxy</a>

<li>
<a href="http://affectioncode.wordpress.com/2008/06/28/another-comparison-of-haproxy-and-nginx/ ">Another comparison of HAProxy and Nginx</a>

<li>
<a href="http://blog.webmynd.com/2008/06/23/scaling-on-ec2/ ">Scaling on EC2</a>

<li>
<a href="http://alword.wordpress.com/2008/06/14/haproxy-on-opensolaris-200805/ ">HAProxy on Opensolaris 2008.05</a>

<li>
<a href="http://www.igvita.com/2008/05/13/load-balancing-qos-with-haproxy/ ">Load-Balancing and QoS with HAProxy</a>

</ul>


<!--// commentwrap Start-->
<!-- 加载duoshuo.com 评论插件 -->
<div id="commentwrap">
<h2>Leave a comment?</h2>
<hr>
    <div id="disqus_thread" style=""></div>

        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jackchim'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>


        
</div>
<!--// commentwrap End-->

</div>
<!--// content  End-->
<!--// footer Start-->
<div class="clear">&nbsp;</div>
<div id="footnote" align="center">
	  Cheers!! Vimwiki  © Copyright 2012 Jack Chim. All Rights Reserved.
</div>
<!--// footer End-->
<!-- http://blog.sonitech.org/2011/07/06/sshscp-through-gateway/ -->
</div>

</div>
<a href="javascript:;" id="returnTop" style="bottom: 200px;">回到顶部</a>
<script type="text/javascript">
$(document).ready(function(){
    initTxt();
    //$('#returnTop').hide();
    $(window).scroll(function(){
        if($(document).scrollTop()>=100){
            if($.browser.msie&&($.browser.version == "6.0")){
                $('#returnTop').css("_top","expression(eval(document.documentElement.scrollTop+(document.documentElement.clientHeight/2)-this.offsetHeight-(parseInt(this.currentStyle.marginTop,10)||0)-(parseInt(this.currentStyle.marginBottom,10)||0))-0);");
            }
            $('#returnTop').animate({bottom:"200px"},{ queue: false, duration: 10 });
        }else{
            $('#returnTop').css("_top","1000");
            $('#returnTop').animate({bottom:"-200px"},{ queue: false, duration: 10 });
        }
    });
    $('#returnTop').click(function(){
        $('html, body').animate({scrollTop:0}, 'slow');
        return false;
    });
 
     
});
 
function initTxt(){
    for(var i=0;i<=300;i++){
        $("#bigBox").append("<p>这是第"+i+"行</p>");
    }
}
</script>
</body>
</html>
